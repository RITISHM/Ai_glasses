<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuralLense Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", sans-serif;
      }

      .pulse-dot {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .message-enter {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      audio {
        filter: sepia(20%) saturate(70%) grayscale(1) contrast(99%) invert(12%);
      }

      audio::-webkit-media-controls-panel {
        background-color: #1f2937;
      }

      .scrollbar-thin::-webkit-scrollbar {
        width: 8px;
      }

      .scrollbar-thin::-webkit-scrollbar-track {
        background: #1f2937;
      }

      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }

      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }
    </style>
  </head>
  <body class="bg-gray-900">
    <div id="app" class="flex flex-col h-screen">
      <!-- Header -->
      <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between max-w-5xl mx-auto">
          <div class="flex items-center gap-3">
            <div
              class="flex items-center gap-2 gradient-bg text-white px-4 py-2 rounded-lg"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
              <span class="font-bold">AuralLense</span>
            </div>
            <div class="text-sm text-gray-400">ESP32 Vision Assistant</div>
          </div>

          <div class="flex items-center gap-3">
            <div
              id="connectionStatus"
              class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-yellow-500/20 text-yellow-400"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"
                ></path>
              </svg>
              <span>Connecting...</span>
            </div>

            <button
              onclick="addDemoMessage()"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm transition-colors"
            >
              Add Demo
            </button>

            <button
              onclick="clearMessages()"
              class="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg text-sm transition-colors"
            >
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto scrollbar-thin">
        <div class="max-w-4xl mx-auto px-4 py-8">
          <div id="messages">
            <!-- Empty state -->
            <div
              id="emptyState"
              class="flex flex-col items-center justify-center text-center py-20"
            >
              <div class="gradient-bg p-6 rounded-full mb-6">
                <svg
                  class="w-12 h-12 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                  ></path>
                </svg>
              </div>
              <h2 class="text-3xl font-bold text-white mb-3">
                AuralLense Ready
              </h2>
              <p class="text-gray-400 text-lg mb-8 max-w-md">
                Waiting for ESP32 to send image and audio...
              </p>
              <div class="grid grid-cols-2 gap-4 text-left max-w-2xl">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                  <svg
                    class="w-6 h-6 text-blue-400 mb-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                  </svg>
                  <div class="text-sm font-semibold text-white mb-1">
                    Image Capture
                  </div>
                  <div class="text-xs text-gray-400">
                    OV2640 camera captures the scene
                  </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                  <svg
                    class="w-6 h-6 text-purple-400 mb-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                    ></path>
                  </svg>
                  <div class="text-sm font-semibold text-white mb-1">
                    Voice Input
                  </div>
                  <div class="text-xs text-gray-400">
                    Ask questions about what you see
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-800 border-t border-gray-700 px-6 py-3">
        <div class="max-w-5xl mx-auto">
          <div class="flex items-center justify-between text-xs text-gray-400">
            <div class="flex items-center gap-4">
              <span>Messages: <span id="messageCount">0</span></span>
              <span>•</span>
              <span>Protocol: Image + Audio → AI Response</span>
            </div>
            <div>Powered by ESP32 & Flask</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let messages = [];
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 10;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();
      });

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/broadcast`;

        try {
          ws = new WebSocket(wsUrl);

          ws.onopen = () => {
            console.log("WebSocket connected");
            reconnectAttempts = 0;
            updateConnectionStatus(true, "Connected");
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              handleIncomingMessage(data);
            } catch (e) {
              console.error("Failed to parse message:", e);
            }
          };

          ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            updateConnectionStatus(false, "Connection error");
          };

          ws.onclose = () => {
            console.log("WebSocket closed");
            updateConnectionStatus(false, "Disconnected");

            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
              reconnectAttempts++;
              const delay = Math.min(
                1000 * Math.pow(2, reconnectAttempts),
                30000
              );
              console.log(
                `Reconnecting in ${
                  delay / 1000
                }s... (attempt ${reconnectAttempts})`
              );
              setTimeout(connectWebSocket, delay);
            }
          };
        } catch (error) {
          console.error("Failed to create WebSocket:", error);
          updateConnectionStatus(false, "Connection failed");
        }
      }

      function updateConnectionStatus(connected, text) {
        const statusEl = document.getElementById("connectionStatus");
        if (connected) {
          statusEl.className =
            "flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-green-500/20 text-green-400";
          statusEl.innerHTML = `
                    <svg class="w-2 h-2 fill-current pulse-dot" viewBox="0 0 8 8">
                        <circle cx="4" cy="4" r="4"/>
                    </svg>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                    </svg>
                    <span>${text}</span>
                `;
        } else {
          statusEl.className =
            "flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-red-500/20 text-red-400";
          statusEl.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"></path>
                    </svg>
                    <span>${text}</span>
                `;
        }
      }

      function handleIncomingMessage(data) {
        if (data.type === "transcription") {
          addUserMessage(data.transcription, data.image_url);
        } else if (data.type === "response") {
          addAssistantMessage(data.response_text, data.audio_url);
        }
      }

      function addUserMessage(text, imageUrl) {
        const timestamp = new Date().toLocaleTimeString();
        const message = {
          id: Date.now(),
          role: "user",
          content: text,
          image: imageUrl,
          timestamp: timestamp,
        };
        messages.push(message);
        renderMessage(message);
        updateMessageCount();
        scrollToBottom();
      }

      function addAssistantMessage(text, audioUrl) {
        const timestamp = new Date().toLocaleTimeString();
        const message = {
          id: Date.now(),
          role: "assistant",
          content: text,
          audio: audioUrl,
          timestamp: timestamp,
        };
        messages.push(message);
        renderMessage(message);
        updateMessageCount();
        scrollToBottom();
      }

      function renderMessage(message) {
        // Hide empty state
        const emptyState = document.getElementById("emptyState");
        if (emptyState) {
          emptyState.style.display = "none";
        }

        const messagesEl = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `mb-8 flex ${
          message.role === "user" ? "justify-end" : "justify-start"
        } message-enter`;

        const isUser = message.role === "user";
        const bgColor = isUser
          ? "bg-blue-600"
          : "bg-gray-800 border border-gray-700";
        const labelBg = isUser
          ? "bg-blue-500/20 text-blue-300"
          : "bg-purple-500/20 text-purple-300";
        const icon = isUser
          ? `
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            `
          : `
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            `;

        messageDiv.innerHTML = `
                <div class="max-w-3xl ${isUser ? "ml-auto" : "mr-auto"}">
                    <div class="flex items-center gap-2 mb-2 ${
                      isUser ? "justify-end" : "justify-start"
                    }">
                        <div class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium ${labelBg}">
                            ${icon}
                            <span>${isUser ? "You" : "AuralLense AI"}</span>
                            <span class="text-gray-500">• ${
                              message.timestamp
                            }</span>
                        </div>
                    </div>
                    <div class="rounded-2xl overflow-hidden ${bgColor}">
                        ${
                          message.image
                            ? `
                            <div class="relative">
                                <img src="${message.image}" alt="Captured" class="w-full max-h-96 object-cover" 
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%23374151\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%239CA3AF\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3EImage Not Available%3C/text%3E%3C/svg%3E'">
                                <div class="absolute top-3 right-3 bg-black/60 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs text-white flex items-center gap-2">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    ESP32 Camera
                                </div>
                            </div>
                        `
                            : ""
                        }
                        <div class="p-4">
                            <p class="text-base leading-relaxed ${
                              isUser ? "text-white" : "text-gray-100"
                            }">
                                ${escapeHtml(message.content)}
                            </p>
                        </div>
                        ${
                          message.audio
                            ? `
                            <div class="px-4 pb-4">
                                <audio controls class="w-full" style="height: 40px">
                                    <source src="${message.audio}" type="audio/wav">
                                    Your browser does not support audio playback.
                                </audio>
                            </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;

        messagesEl.appendChild(messageDiv);
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function scrollToBottom() {
        const container = document.getElementById("messagesContainer");
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 100);
      }

      function updateMessageCount() {
        document.getElementById("messageCount").textContent = messages.length;
      }

      function clearMessages() {
        if (confirm("Clear all messages?")) {
          messages = [];
          document.getElementById("messages").innerHTML = `
                    <div id="emptyState" class="flex flex-col items-center justify-center text-center py-20">
                        <div class="gradient-bg p-6 rounded-full mb-6">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-3">AuralLense Ready</h2>
                        <p class="text-gray-400 text-lg mb-8 max-w-md">
                            Waiting for ESP32 to send image and audio...
                        </p>
                        <div class="grid grid-cols-2 gap-4 text-left max-w-2xl">
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                <svg class="w-6 h-6 text-blue-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <div class="text-sm font-semibold text-white mb-1">Image Capture</div>
                                <div class="text-xs text-gray-400">OV2640 camera captures the scene</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                <svg class="w-6 h-6 text-purple-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                                <div class="text-sm font-semibold text-white mb-1">Voice Input</div>
                                <div class="text-xs text-gray-400">Ask questions about what you see</div>
                            </div>
                        </div>
                    </div>
                `;
          updateMessageCount();
        }
      }

      function addDemoMessage() {
        addUserMessage(
          "What do you see in this image?",
          "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400"
        );

        setTimeout(() => {
          addAssistantMessage(
            "I can see a beautiful mountain landscape with snow-capped peaks against a blue sky. The image shows a serene natural setting with impressive geological formations.",
            null
          );
        }, 1000);
      }
    </script>
  </body>
</html>
